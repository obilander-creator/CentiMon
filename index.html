<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CentimOn - Gestió Avançada</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Estil pels inputs de data */
        input[type="date"], input[type="month"] { appearance: none; -webkit-appearance: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
            PieChart, Wallet, Users, TrendingUp, TrendingDown, Trash2, PlusCircle, 
            LayoutDashboard, ArrowRightLeft, PiggyBank, Briefcase, Baby, Building2, 
            CandlestickChart, Coins, Landmark, Percent, Menu, Sparkles, Bot, MessageSquare,
            LogOut, Lock, Mail, Search, Calendar, Filter, X, Settings
        } from 'https://esm.sh/lucide-react@0.344.0';
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut,
            onAuthStateChanged, setPersistence, browserLocalPersistence, sendPasswordResetEmail 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, collection, query, onSnapshot, addDoc, serverTimestamp, deleteDoc, doc, setLogLevel, setDoc, getDoc 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // --- ⚠️ CONFIGURACIÓN (VUELVE A PEGAR TUS CLAVES AQUÍ) ⚠️ ---
        const firebaseConfig = { apiKey: "AIzaSyD2HSJ70uHQ1nB_ed1uR-YTEGPD4aYNyoY",
  authDomain: "obifinance.firebaseapp.com",
  projectId: "obifinance",
  storageBucket: "obifinance.firebasestorage.app",
  messagingSenderId: "298738778334",
  appId: "1:298738778334:web:4c16ffcecf2a3ccbe4424f"
        };
        
        const geminiApiKey = ""; 
        // -----------------------------------------------------------

        let app, db, auth;
        try {
            const hasConfig = Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey && firebaseConfig.apiKey.length > 5;
            if (hasConfig) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setPersistence(auth, browserLocalPersistence);
                setLogLevel('silent');
            }
        } catch (e) { console.error("Error init:", e); }

        // --- CONSTANTS I UTILITATS ---
        const AssetClasses = { CASH: 'cash', ETF: 'etf', STOCK: 'stock', CRYPTO: 'crypto' };
        
        // Configuració de comptes per defecte (sense Filla, esborrable)
        const DefaultAccounts = {
            'main': { id: 'main', label: 'Principal', icon: 'Wallet', color: 'text-indigo-600', bg: 'bg-indigo-100', isSystem: true },
            'savings': { id: 'savings', label: 'Estalvi', icon: 'PiggyBank', color: 'text-emerald-600', bg: 'bg-emerald-100', isSystem: true },
            'invest': { id: 'invest', label: 'Inversió', icon: 'CandlestickChart', color: 'text-blue-600', bg: 'bg-blue-100', isSystem: true },
            'joint': { id: 'joint', label: 'Comú', icon: 'Users', color: 'text-pink-600', bg: 'bg-pink-100', isSystem: true },
        };

        const AssetConfig = {
            [AssetClasses.CASH]: { label: 'Efectiu', icon: Landmark, color: '#60A5FA' }, 
            [AssetClasses.ETF]: { label: 'Fons', icon: PieChart, color: '#F59E0B' }, 
            [AssetClasses.STOCK]: { label: 'Accions', icon: Building2, color: '#3B82F6' }, 
            [AssetClasses.CRYPTO]: { label: 'Cripto', icon: Coins, color: '#F472B6' }, 
        };
        
        const TxType = { INCOME: 'income', EXPENSE: 'expense', TRANSFER_OUT: 'transfer_out', TRANSFER_IN: 'transfer_in', INVEST_BUY: 'invest_buy', INVEST_SELL: 'invest_sell', INVEST_YIELD: 'invest_yield' };
        const FormTxOptions = { EXPENSE: 'Despesa', INCOME: 'Ingrés', TRANSFER: 'Traspàs' };
        const InvestTxOptions = { BUY: 'Comprar', SELL: 'Vendre', YIELD: 'Dividend', DEPOSIT: 'Ingrés', WITHDRAW: 'Retirada' };
        
        const CATEGORIES = {
            [TxType.EXPENSE]: [
                { id: 'food', label: 'Alimentació', color: '#EF4444' }, 
                { id: 'housing', label: 'Habitatge', color: '#F97316' }, 
                { id: 'transport', label: 'Transport', color: '#EAB308' }, 
                { id: 'leisure', label: 'Oci', color: '#8B5CF6' }, 
                { id: 'health', label: 'Salut', color: '#EC4899' }, 
                { id: 'bills', label: 'Subministraments', color: '#6366F1' }, 
                { id: 'shopping', label: 'Compres', color: '#14B8A6' }, 
                { id: 'other_expense', label: 'Altres', color: '#64748B' } // "Altres" és especial
            ],
            [TxType.INCOME]: [
                { id: 'salary', label: 'Nòmina', color: '#22C55E' }, 
                { id: 'freelance', label: 'Autònom', color: '#84CC16' }, 
                { id: 'investments', label: 'Rendiments', color: '#06B6D4' }, 
                { id: 'gifts', label: 'Regals', color: '#A855F7' }, 
                { id: 'other_income', label: 'Altres', color: '#94A3B8' }
            ]
        };

        // Funció per generar colors a partir d'un text (per les categories personalitzades)
        const stringToColor = (str) => {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return '#' + '00000'.substring(0, 6 - c.length) + c;
        };

        // Mapeig d'icones strings a components
        const IconMap = { Wallet, PiggyBank, CandlestickChart, Users, Briefcase, Baby, Building2, Coins, Sparkles };

        // --- COMPONENTS ---

        const AuthScreen = () => {
            const [isLogin, setIsLogin] = useState(true);
            const [isReset, setIsReset] = useState(false); // Estat per "He oblidat contrasenya"
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [message, setMessage] = useState(''); // Missatge d'èxit
            const [loading, setLoading] = useState(false);

            const handleAuth = async (e) => {
                e.preventDefault();
                setError('');
                setMessage('');
                setLoading(true);
                if (!auth) { setError("Falta config Firebase."); setLoading(false); return; }
                try {
                    if (isReset) {
                         // Lògica per recuperar contrasenya
                         await sendPasswordResetEmail(auth, email);
                         setMessage("Correu de recuperació enviat. Revisa la teva safata d'entrada.");
                         setLoading(false);
                         return;
                    }

                    if (isLogin) await signInWithEmailAndPassword(auth, email, password);
                    else await createUserWithEmailAndPassword(auth, email, password);
                } catch (err) { 
                    console.error(err);
                    let msg = "Error desconegut";
                    if (err.code === 'auth/invalid-credential') msg = "Credencials incorrectes.";
                    if (err.code === 'auth/user-not-found') msg = "Usuari no trobat.";
                    if (err.code === 'auth/wrong-password') msg = "Contrasenya incorrecta.";
                    if (err.code === 'auth/email-already-in-use') msg = "Aquest email ja està registrat.";
                    if (err.code === 'auth/weak-password') msg = "La contrasenya ha de tenir mínim 6 caràcters.";
                    setError(msg); 
                } 
                finally { setLoading(false); }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-indigo-500 to-purple-600">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md animate-fadeIn">
                        <div className="text-center mb-8">
                            <div className="bg-indigo-100 p-3 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4"><Coins className="w-8 h-8 text-indigo-600" /></div>
                            <h1 className="text-2xl font-bold text-gray-800">
                                {isReset ? 'Recuperar Contrasenya' : (isLogin ? 'Benvingut' : 'Crear Compte')}
                            </h1>
                            <p className="text-sm text-gray-500 mt-2">CentimOn</p>
                        </div>
                        
                        {error && <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm mb-4">{error}</div>}
                        {message && <div className="bg-green-50 text-green-600 p-3 rounded-lg text-sm mb-4">{message}</div>}
                        
                        <form onSubmit={handleAuth} className="space-y-4">
                            <input type="email" value={email} onChange={e=>setEmail(e.target.value)} className="w-full p-3 border rounded-xl" placeholder="Email" required />
                            
                            {!isReset && (
                                <input type="password" value={password} onChange={e=>setPassword(e.target.value)} className="w-full p-3 border rounded-xl" placeholder="Contrasenya" required />
                            )}
                            
                            <button type="submit" disabled={loading} className="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl">
                                {loading ? '...' : (isReset ? 'Enviar Correu' : (isLogin ? 'Entrar' : 'Registrar'))}
                            </button>
                        </form>

                        {!isReset && (
                            <div className="text-center mt-3">
                                <button onClick={() => { setIsReset(true); setError(''); setMessage(''); }} className="text-xs text-gray-500 hover:text-indigo-600">
                                    He oblidat la contrasenya
                                </button>
                            </div>
                        )}

                        <button onClick={()=>{ 
                            if (isReset) { setIsReset(false); setError(''); setMessage(''); }
                            else { setIsLogin(!isLogin); setError(''); setMessage(''); }
                        }} className="w-full mt-4 text-sm text-indigo-600 hover:underline">
                            {isReset ? 'Tornar al Login' : (isLogin ? 'Crear compte' : 'Ja tinc compte')}
                        </button>
                    </div>
                </div>
            );
        };

        const DateFilter = ({ filter, setFilter }) => {
            return (
                <div className="bg-white p-3 rounded-xl shadow-sm border border-gray-100 mb-4 flex flex-col md:flex-row gap-3 items-center justify-between">
                    <div className="flex bg-gray-100 p-1 rounded-lg">
                        <button onClick={() => setFilter(prev => ({ ...prev, mode: 'month' }))} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${filter.mode === 'month' ? 'bg-white shadow text-indigo-600' : 'text-gray-500'}`}>Mes</button>
                        <button onClick={() => setFilter(prev => ({ ...prev, mode: 'range' }))} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${filter.mode === 'range' ? 'bg-white shadow text-indigo-600' : 'text-gray-500'}`}>Rang</button>
                    </div>
                    
                    {filter.mode === 'month' ? (
                        <div className="flex items-center bg-gray-50 border border-gray-200 rounded-lg px-3 py-1.5 w-full md:w-auto">
                            <Calendar className="w-4 h-4 text-gray-400 mr-2" />
                            <input 
                                type="month" 
                                value={filter.monthStr} 
                                onChange={(e) => setFilter(prev => ({ ...prev, monthStr: e.target.value }))}
                                className="bg-transparent text-sm outline-none text-gray-700 w-full"
                            />
                        </div>
                    ) : (
                        <div className="flex items-center gap-2 w-full md:w-auto text-sm">
                            <input type="date" value={filter.start} onChange={e => setFilter(prev => ({...prev, start: e.target.value}))} className="border p-1.5 rounded-lg w-full" />
                            <span className="text-gray-400">a</span>
                            <input type="date" value={filter.end} onChange={e => setFilter(prev => ({...prev, end: e.target.value}))} className="border p-1.5 rounded-lg w-full" />
                        </div>
                    )}
                </div>
            );
        };

        const DonutChart = ({ data, total, title, centerLabel }) => {
            if (total === 0) return <div className="h-40 w-40 flex items-center justify-center text-gray-400 bg-gray-50 rounded-full border-4 border-gray-100 mx-auto"><span className="text-xs">Buit</span></div>;
            let cumulativePercent = 0;
            const slices = data.map((slice) => {
                const startPercent = cumulativePercent; const slicePercent = slice.value / total; cumulativePercent += slicePercent; const endPercent = cumulativePercent;
                const x1 = Math.cos(2 * Math.PI * startPercent); const y1 = Math.sin(2 * Math.PI * startPercent);
                const x2 = Math.cos(2 * Math.PI * endPercent); const y2 = Math.sin(2 * Math.PI * endPercent);
                const largeArcFlag = slicePercent > 0.5 ? 1 : 0;
                const pathData = `M ${x1} ${y1} A 1 1 0 ${largeArcFlag} 1 ${x2} ${y2} L 0 0`;
                return <path key={slice.id} d={pathData} fill={slice.color} className="transition-opacity hover:opacity-80" />;
            });
            return <div className="relative w-40 h-40 mx-auto"><svg viewBox="-1 -1 2 2" className="transform -rotate-90 w-full h-full">{slices}</svg><div className="absolute inset-0 flex items-center justify-center pointer-events-none"><div className="w-24 h-24 bg-white rounded-full flex flex-col items-center justify-center shadow-sm"><span className="text-[10px] text-gray-400 uppercase">{title || 'Total'}</span><span className="text-sm font-bold text-gray-700">{centerLabel || `${Math.abs(total).toFixed(0)}€`}</span></div></div></div>;
        };

        const TransactionForm = ({ db, userId, activeAccount, accounts }) => {
            const isInvest = activeAccount === 'invest'; // Simplificació: només "invest" és inversió
            const [description, setDescription] = useState('');
            const [amount, setAmount] = useState('');
            const [formType, setFormType] = useState(FormTxOptions.EXPENSE);
            const [category, setCategory] = useState('');
            const [customCategory, setCustomCategory] = useState(''); // Nou camp per "Altres"
            const [targetAccount, setTargetAccount] = useState('savings');
            const [investType, setInvestType] = useState(InvestTxOptions.BUY);
            const [assetClass, setAssetClass] = useState(AssetClasses.ETF);
            const [loading, setLoading] = useState(false);
            const [isExpanded, setIsExpanded] = useState(false);

            useEffect(() => { 
                if (isInvest) { setInvestType(InvestTxOptions.BUY); setAssetClass(AssetClasses.ETF); } 
                else { setFormType(FormTxOptions.EXPENSE); setCategory(CATEGORIES[TxType.EXPENSE][0].id); setCustomCategory(''); } 
            }, [activeAccount, isInvest]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!userId || !amount) return;
                setLoading(true);
                try {
                    const numAmount = parseFloat(amount);
                    const collectionRef = collection(db, `users/${userId}/finances`);
                    const baseData = { description: description.trim(), timestamp: serverTimestamp(), account: activeAccount };
                    
                    // Lògica per categoria personalitzada
                    let finalCategory = category;
                    let finalDescription = description.trim();
                    let finalCustomCatName = null;

                    if (!isInvest && (category === 'other_expense' || category === 'other_income') && customCategory.trim()) {
                         finalCustomCatName = customCategory.trim(); // Guardem el nom personalitzat
                         finalDescription = `${finalCustomCatName}: ${description.trim()}`; // Afegim al text
                    }

                    if (isInvest) {
                        let txData = { ...baseData };
                        if (investType === InvestTxOptions.BUY) { txData = {...txData, type: TxType.INVEST_BUY, amount: 0, assetAmount: numAmount, assetClass, description: `Compra ${AssetConfig[assetClass].label}: ${description}`}; }
                        else if (investType === InvestTxOptions.SELL) { txData = {...txData, type: TxType.INVEST_SELL, amount: 0, assetAmount: numAmount, assetClass, description: `Venda ${AssetConfig[assetClass].label}: ${description}`}; }
                        else if (investType === InvestTxOptions.YIELD) { txData = {...txData, type: TxType.INVEST_YIELD, amount: numAmount, category: 'yield'}; }
                        else if (investType === InvestTxOptions.DEPOSIT) { txData = {...txData, type: TxType.TRANSFER_IN, amount: numAmount}; }
                        await addDoc(collectionRef, txData);
                    } else {
                        if (formType === FormTxOptions.TRANSFER) {
                            await addDoc(collectionRef, { ...baseData, description: `Traspàs a ${accounts[targetAccount].label}: ${description}`, amount: -numAmount, type: TxType.TRANSFER_OUT, relatedAccount: targetAccount });
                            await addDoc(collectionRef, { description: `Rebut de ${accounts[activeAccount].label}: ${description}`, amount: numAmount, type: TxType.TRANSFER_IN, account: targetAccount, relatedAccount: activeAccount, timestamp: serverTimestamp() });
                        } else {
                            const realType = formType === FormTxOptions.EXPENSE ? TxType.EXPENSE : TxType.INCOME;
                            await addDoc(collectionRef, { 
                                ...baseData, 
                                amount: realType === TxType.EXPENSE ? -numAmount : numAmount, 
                                type: realType, 
                                category: finalCategory,
                                customCategory: finalCustomCatName // Guardem el camp extra
                            });
                        }
                    }
                    setDescription(''); setAmount(''); setCustomCategory(''); setIsExpanded(false);
                } catch (err) { alert("Error: " + err.message); } 
                finally { setLoading(false); }
            };

            return (
                <div className="bg-white rounded-2xl shadow-sm border border-gray-100 mb-6 overflow-hidden transition-all">
                    <button onClick={() => setIsExpanded(!isExpanded)} className="w-full p-4 flex items-center justify-between bg-white hover:bg-gray-50 transition"><div className="flex items-center text-sm font-bold text-gray-800 uppercase tracking-wide"><PlusCircle className="w-5 h-5 mr-2 text-indigo-600" />{isInvest ? 'Operar' : 'Afegir Moviment'}</div><div className={`transform transition-transform ${isExpanded ? 'rotate-180' : ''}`}><ArrowRightLeft className="w-5 h-5 text-gray-400 rotate-90" /></div></button>
                    <div className={`${isExpanded ? 'block' : 'hidden'} px-4 pb-6 border-t border-gray-100`}>
                        <form onSubmit={handleSubmit} className="space-y-4 mt-2">
                            <div className="flex bg-gray-100 p-1 rounded-xl overflow-x-auto no-scrollbar">{(isInvest ? Object.values(InvestTxOptions) : Object.values(FormTxOptions)).map((opt) => (<button key={opt} type="button" onClick={() => isInvest ? setInvestType(opt) : setFormType(opt)} className={`flex-1 py-2 px-3 text-xs font-semibold rounded-lg transition-all whitespace-nowrap ${(isInvest ? investType : formType) === opt ? 'bg-white shadow-sm text-indigo-600 ring-1 ring-black/5' : 'text-gray-500 hover:text-gray-700'}`}>{opt}</button>))}</div>
                            <div className="space-y-3">
                                <input type="number" inputMode="decimal" value={amount} onChange={(e) => setAmount(e.target.value)} className="w-full p-3 border border-gray-200 rounded-xl text-lg font-semibold placeholder-gray-300 outline-none" placeholder="0.00 €" required />
                                <input type="text" value={description} onChange={(e) => setDescription(e.target.value)} className="w-full p-3 border border-gray-200 rounded-xl text-base placeholder-gray-400 outline-none" placeholder={isInvest ? "Detall..." : "Concepte..."} required />
                            </div>
                            
                            {/* Selector Categoria / Actius */}
                            {isInvest && (investType === InvestTxOptions.BUY || investType === InvestTxOptions.SELL) && (<div className="grid grid-cols-4 gap-2">{Object.entries(AssetConfig).filter(([k]) => k !== AssetClasses.CASH).map(([key, config]) => (<button key={key} type="button" onClick={() => setAssetClass(key)} className={`p-2 flex flex-col items-center justify-center rounded-xl border transition-all ${assetClass === key ? 'bg-blue-50 border-blue-500 text-blue-700' : 'border-gray-100 text-gray-500 bg-gray-50'}`}><config.icon className="w-5 h-5 mb-1" /><span className="text-[10px] font-medium">{config.label}</span></button>))}</div>)}
                            {!isInvest && formType === FormTxOptions.TRANSFER && (<div className="bg-indigo-50 p-3 rounded-xl border border-indigo-100"><label className="text-xs font-bold text-indigo-800 mb-2 flex items-center uppercase"><ArrowRightLeft className="w-3 h-3 mr-1" /> Destí</label><select value={targetAccount} onChange={(e) => setTargetAccount(e.target.value)} className="w-full p-2 border border-indigo-200 rounded-lg text-sm bg-white outline-none">{Object.entries(accounts).filter(([key]) => key !== activeAccount).map(([key, config]) => (<option key={key} value={key}>{config.label}</option>))}</select></div>)}
                            {!isInvest && formType !== FormTxOptions.TRANSFER && (
                                <div className="space-y-3">
                                    <div className="grid grid-cols-4 gap-2">
                                        {CATEGORIES[formType === FormTxOptions.EXPENSE ? TxType.EXPENSE : TxType.INCOME]?.map((cat) => (
                                            <button key={cat.id} type="button" onClick={() => setCategory(cat.id)} className={`p-2 flex flex-col items-center justify-center rounded-xl border transition-all h-16 ${category === cat.id ? 'bg-gray-800 border-gray-800 text-white shadow-md' : 'border-gray-100 text-gray-500 bg-gray-50'}`}>
                                                <div className={`w-2 h-2 rounded-full mb-1 ${category === cat.id ? 'bg-white' : ''}`} style={{ backgroundColor: category === cat.id ? '' : cat.color }}></div>
                                                <span className="text-[9px] font-medium text-center leading-tight">{cat.label}</span>
                                            </button>
                                        ))}
                                    </div>
                                    {/* Input extra per "Altres" */}
                                    {(category === 'other_expense' || category === 'other_income') && (
                                        <div className="animate-fadeIn bg-yellow-50 p-3 rounded-xl border border-yellow-100">
                                            <label className="text-xs font-bold text-yellow-800 mb-1 block">Especifica la categoria:</label>
                                            <input type="text" value={customCategory} onChange={(e) => setCustomCategory(e.target.value)} className="w-full p-2 border border-yellow-200 rounded-lg text-sm bg-white" placeholder="Ex: Pàdel, Classes, etc." required />
                                        </div>
                                    )}
                                </div>
                            )}
                            <button type="submit" disabled={loading} className={`w-full text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-95 transition-transform ${isInvest ? 'bg-blue-600' : 'bg-indigo-600'}`}>{loading ? '...' : 'Guardar'}</button>
                        </form>
                    </div>
                </div>
            );
        };

        const TransactionsList = ({ transactions, db, userId }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const handleDelete = async (id) => { if (!confirm('Eliminar?')) return; try { await deleteDoc(doc(db, `users/${userId}/finances`, id)); } catch (error) { console.error(error); } };
            
            const filtered = useMemo(() => {
                if(!searchTerm) return transactions;
                const lower = searchTerm.toLowerCase();
                return transactions.filter(t => 
                    t.description.toLowerCase().includes(lower) || 
                    (t.customCategory && t.customCategory.toLowerCase().includes(lower)) ||
                    t.amount.toString().includes(lower)
                );
            }, [transactions, searchTerm]);

            return (
                <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-20 md:mb-0">
                    <div className="p-4 border-b border-gray-100 bg-gray-50 flex flex-col gap-3">
                        <div className="flex justify-between items-center"><h3 className="font-bold text-gray-700 text-sm uppercase tracking-wide">Moviments</h3></div>
                        {/* Buscador */}
                        <div className="relative">
                            <Search className="w-4 h-4 absolute left-3 top-2.5 text-gray-400" />
                            <input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="Buscar moviments..." className="w-full pl-9 p-2 text-sm border border-gray-200 rounded-lg outline-none focus:ring-1 focus:ring-indigo-500" />
                        </div>
                    </div>
                    <div className="divide-y divide-gray-100 max-h-[500px] overflow-y-auto">
                        {filtered.length === 0 ? <div className="p-8 text-center text-gray-400 text-sm">No s'han trobat moviments</div> : filtered.map((t) => { 
                            const isInvestOp = t.type.startsWith('invest');
                            const isPositive = t.amount > 0;
                            const catDef = t.type === TxType.EXPENSE ? CATEGORIES[TxType.EXPENSE].find(c=>c.id===t.category) : CATEGORIES[TxType.INCOME].find(c=>c.id===t.category);
                            
                            // Si és custom, usem el seu nom, si no, l'etiqueta per defecte
                            const label = t.customCategory || catDef?.label || 'General';
                            
                            return (
                            <div key={t.id} className="p-4 flex items-center justify-between active:bg-gray-50">
                                <div className="flex items-center space-x-3">
                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center shrink-0 ${isInvestOp ? 'bg-blue-100 text-blue-600' : isPositive ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                                        {isInvestOp ? <CandlestickChart className="w-5 h-5" /> : isPositive ? <TrendingUp className="w-5 h-5" /> : <TrendingDown className="w-5 h-5" />}
                                    </div>
                                    <div className="min-w-0">
                                        <p className="font-semibold text-gray-800 text-sm truncate pr-2">{t.description}</p>
                                        <div className="flex items-center text-xs text-gray-500 space-x-2">
                                            <span>{t.timestamp?.toDate ? t.timestamp.toDate().toLocaleDateString('ca-ES', {day: '2-digit', month: '2-digit'}) : '--/--'}</span>
                                            <span className="px-1.5 py-0.5 rounded-md bg-gray-100 text-[10px] font-medium uppercase tracking-wide truncate max-w-[100px]">{label}</span>
                                        </div>
                                    </div>
                                </div>
                                <div className="flex flex-col items-end pl-2">
                                    <span className={`font-bold text-sm ${isInvestOp ? 'text-blue-800' : isPositive ? 'text-green-600' : 'text-gray-800'}`}>
                                        {t.type === TxType.INVEST_BUY ? `+${t.assetAmount}€` : t.amount !== 0 ? `${t.amount > 0 ? '+' : ''}${t.amount.toFixed(2)} €` : `-${t.assetAmount}€`}
                                    </span>
                                    <button onClick={() => handleDelete(t.id)} className="text-gray-300 p-1 -mr-1"><Trash2 className="w-4 h-4" /></button>
                                </div>
                            </div>
                        ); })}
                    </div>
                </div>
            );
        };

        const Analytics = ({ transactions, activeAccount }) => {
            const isInvest = activeAccount === 'invest';
            const data = useMemo(() => {
                if (isInvest) { 
                    let portfolio = { [AssetClasses.CASH]: 0, [AssetClasses.ETF]: 0, [AssetClasses.STOCK]: 0, [AssetClasses.CRYPTO]: 0 };
                    transactions.forEach(t => { 
                        if (t.type === TxType.INVEST_BUY) { portfolio[AssetClasses.CASH] -= t.assetAmount; portfolio[t.assetClass] = (portfolio[t.assetClass] || 0) + t.assetAmount; }
                        else if (t.type === TxType.INVEST_SELL) { portfolio[AssetClasses.CASH] += t.assetAmount; portfolio[t.assetClass] = (portfolio[t.assetClass] || 0) - t.assetAmount; }
                        else { portfolio[AssetClasses.CASH] += t.amount; }
                    });
                    const chartData = Object.entries(portfolio).map(([key, value]) => ({ id: key, label: AssetConfig[key].label, value: value, color: AssetConfig[key].color })).filter(d => d.value > 0);
                    return { data: chartData, total: chartData.reduce((s, i) => s + i.value, 0) };
                } else { 
                    const grouped = transactions.filter(t => t.type === TxType.EXPENSE).reduce((acc, curr) => {
                        // Agrupar per categoria personalitzada si existeix
                        const key = curr.customCategory ? `custom_${curr.customCategory}` : curr.category || 'other_expense';
                        acc[key] = (acc[key] || 0) + Math.abs(curr.amount);
                        return acc;
                    }, {});
                    
                    const chartData = Object.keys(grouped).map(k => {
                        if (k.startsWith('custom_')) {
                            const name = k.replace('custom_', '');
                            return { id: k, label: name, value: grouped[k], color: stringToColor(name) };
                        }
                        const def = CATEGORIES[TxType.EXPENSE].find(c => c.id === k);
                        return { id: k, label: def?.label || k, value: grouped[k], color: def?.color || '#ccc' };
                    }).sort((a,b) => b.value - a.value);
                    return { data: chartData, total: chartData.reduce((s, i) => s + i.value, 0) };
                }
            }, [transactions, isInvest]);

            return (
                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h3 className="text-xs font-bold text-gray-500 mb-4 uppercase tracking-wide text-center">{isInvest ? 'Distribució' : 'Despeses (Filtrat)'}</h3>
                    <DonutChart data={data.data} total={data.total} title={isInvest ? 'Valor' : 'Total'} />
                    <div className="mt-4 grid grid-cols-2 gap-2">
                        {data.data.slice(0,8).map(d => (
                            <div key={d.id} className="flex items-center text-[10px] bg-gray-50 p-2 rounded-lg">
                                <span className="w-2 h-2 rounded-full mr-2 shrink-0" style={{backgroundColor: d.color}}></span>
                                <span className="truncate flex-1">{d.label}</span>
                                <span className="font-bold">{d.value.toFixed(0)}€</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const SummaryDashboard = ({ transactions, activeAccount, accounts }) => {
            const isInvest = activeAccount === 'invest';
            const data = useMemo(() => {
                let stats = { activeBalance: 0, monthlyIncome: 0, monthlyExpense: 0, investTotal: 0 };
                transactions.forEach(t => {
                    if (t.account === activeAccount) {
                        if (t.type !== TxType.INVEST_BUY && t.type !== TxType.INVEST_SELL) stats.activeBalance += t.amount;
                        if (t.type === TxType.INCOME || t.type === TxType.INVEST_YIELD) stats.monthlyIncome += t.amount;
                        if (t.type === TxType.EXPENSE) stats.monthlyExpense += t.amount;
                    }
                    if (activeAccount === 'invest') {
                        if (t.type === TxType.INVEST_BUY) stats.investTotal += Math.abs(t.assetAmount || 0);
                        if (t.type === TxType.INVEST_SELL) stats.investTotal -= Math.abs(t.assetAmount || 0);
                    }
                });
                if (isInvest) stats.activeBalance += stats.investTotal; // Sumem el valor dels actius al cash
                return stats;
            }, [transactions, activeAccount]);

            const activeConfig = accounts[activeAccount] || DefaultAccounts['main'];
            return (
                <div className="bg-white p-5 rounded-2xl shadow-sm border border-indigo-50 relative overflow-hidden mb-6">
                    <div className="flex justify-between items-start"><p className="text-gray-500 text-[10px] font-bold uppercase tracking-wider mb-1">{isInvest ? 'Valor Total' : `Saldo ${activeConfig.label}`}</p></div>
                    <h2 className="text-3xl font-extrabold text-gray-800 tracking-tight">{data.activeBalance.toFixed(2)} €</h2>
                    {!isInvest && (
                        <div className="flex items-center mt-3 text-xs space-x-3">
                            <span className="text-green-600 flex items-center bg-green-50 px-2 py-1 rounded font-medium"><TrendingUp className="w-3 h-3 mr-1" /> +{data.monthlyIncome.toFixed(0)}€</span>
                            <span className="text-red-500 flex items-center bg-red-50 px-2 py-1 rounded font-medium"><TrendingDown className="w-3 h-3 mr-1" /> {data.monthlyExpense.toFixed(0)}€</span>
                        </div>
                    )}
                </div>
            );
        };

        const AccountsBar = ({ accounts, activeAccount, setActiveAccount, onAddAccount, onDeleteAccount }) => {
            const [isAdding, setIsAdding] = useState(false);
            const [newAccountName, setNewAccountName] = useState('');

            const handleAdd = () => {
                if(!newAccountName.trim()) return;
                onAddAccount(newAccountName.trim());
                setNewAccountName('');
                setIsAdding(false);
            };

            return (
                <div className="mb-6">
                    <div className="flex overflow-x-auto pb-4 gap-3 no-scrollbar">
                        {Object.entries(accounts).map(([key, config]) => {
                            const Icon = IconMap[config.icon] || Wallet;
                            return (
                                <button key={key} onClick={() => setActiveAccount(key)} className={`relative group flex-shrink-0 flex flex-col items-center p-3 rounded-xl border transition-all min-w-[90px] ${activeAccount === key ? 'bg-white border-indigo-500 shadow-md transform scale-105' : 'bg-gray-50 border-gray-200'}`}>
                                    <div className={`p-2 rounded-full mb-2 ${config.bg || 'bg-gray-200'}`}><Icon className={`w-5 h-5 ${config.color || 'text-gray-600'}`} /></div>
                                    <span className="text-xs font-medium truncate w-full text-center">{config.label}</span>
                                    {/* Botó eliminar només per comptes personalitzats */}
                                    {!config.isSystem && activeAccount === key && (
                                        <div onClick={(e) => { e.stopPropagation(); onDeleteAccount(key); }} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5 shadow-sm"><X className="w-3 h-3" /></div>
                                    )}
                                </button>
                            );
                        })}
                        {/* Botó Afegir */}
                        <button onClick={() => setIsAdding(true)} className="flex-shrink-0 flex flex-col items-center justify-center p-3 rounded-xl border border-dashed border-gray-300 min-w-[90px] text-gray-400 hover:bg-gray-50">
                            <PlusCircle className="w-6 h-6 mb-1" />
                            <span className="text-[10px] font-bold">NOU</span>
                        </button>
                    </div>

                    {/* Modal simple per afegir compte */}
                    {isAdding && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-sm animate-fadeIn">
                                <h3 className="font-bold text-lg mb-4">Nou Compte</h3>
                                <input type="text" value={newAccountName} onChange={e => setNewAccountName(e.target.value)} className="w-full border p-2 rounded-lg mb-4" placeholder="Nom (ex: Viatge, Obres...)" autoFocus />
                                <div className="flex gap-2">
                                    <button onClick={() => setIsAdding(false)} className="flex-1 py-2 text-gray-500">Cancel·lar</button>
                                    <button onClick={handleAdd} className="flex-1 py-2 bg-indigo-600 text-white rounded-lg font-bold">Crear</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        function App() {
            const [user, setUser] = useState(null);
            const [transactions, setTransactions] = useState([]);
            const [accounts, setAccounts] = useState(DefaultAccounts);
            const [activeAccount, setActiveAccount] = useState('main');
            const [authLoading, setAuthLoading] = useState(true);
            
            // Estat pel filtre de dates
            const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
            const [dateFilter, setDateFilter] = useState({ mode: 'month', monthStr: currentMonth, start: '', end: '' });

            useEffect(() => {
                if (!auth) { setTimeout(() => setAuthLoading(false), 500); return; }
                const unsub = onAuthStateChanged(auth, u => { setUser(u); setAuthLoading(false); });
                return () => unsub();
            }, []);

            // Carregar comptes personalitzats
            useEffect(() => {
                if (!user || !db) return;
                const loadAccounts = async () => {
                    try {
                        const docRef = doc(db, `users/${user.uid}/settings/config`);
                        const snap = await getDoc(docRef);
                        if (snap.exists() && snap.data().accounts) {
                            setAccounts({ ...DefaultAccounts, ...snap.data().accounts });
                        }
                    } catch (e) { console.error("Error carregant comptes", e); }
                };
                loadAccounts();
                // Carregar transaccions
                const q = query(collection(db, `users/${user.uid}/finances`));
                const unsubTx = onSnapshot(q, (snap) => {
                    const txs = snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                    setTransactions(txs);
                });
                return () => unsubTx();
            }, [user]);

            // Guardar compte nou
            const handleAddAccount = async (name) => {
                const id = 'acc_' + Date.now();
                const newAcc = { id, label: name, icon: 'Briefcase', color: 'text-gray-700', bg: 'bg-gray-100', isSystem: false };
                const updated = { ...accounts, [id]: newAcc };
                setAccounts(updated);
                // Persistir a Firebase
                await setDoc(doc(db, `users/${user.uid}/settings/config`), { accounts: updated }, { merge: true });
                setActiveAccount(id);
            };

            const handleDeleteAccount = async (id) => {
                if(!confirm(`Eliminar compte "${accounts[id].label}"?`)) return;
                const { [id]: deleted, ...rest } = accounts;
                setAccounts(rest);
                setActiveAccount('main');
                await setDoc(doc(db, `users/${user.uid}/settings/config`), { accounts: rest }, { merge: true });
            };

            // FILTRE PRINCIPAL DE TRANSACCIONS
            const filteredTransactions = useMemo(() => {
                // Primer filtrem per compte
                let txs = transactions.filter(t => t.account === activeAccount);
                
                // Després per data
                txs = txs.filter(t => {
                    if (!t.timestamp) return false;
                    const date = t.timestamp.toDate();
                    if (dateFilter.mode === 'month') {
                        const [year, month] = dateFilter.monthStr.split('-');
                        return date.getFullYear() === parseInt(year) && date.getMonth() === parseInt(month) - 1;
                    } else {
                        if (!dateFilter.start || !dateFilter.end) return true;
                        const start = new Date(dateFilter.start); start.setHours(0,0,0,0);
                        const end = new Date(dateFilter.end); end.setHours(23,59,59,999);
                        return date >= start && date <= end;
                    }
                });
                return txs;
            }, [transactions, activeAccount, dateFilter]);

            if (!Object.keys(firebaseConfig).length || !firebaseConfig.apiKey) return <div className="p-8 text-center text-red-600">Falta Config Firebase</div>;
            if (authLoading) return <div className="h-screen flex items-center justify-center text-gray-400">Carregant...</div>;
            if (!user) return <AuthScreen />;

            return (
                <div className="min-h-screen bg-gray-50 font-sans text-gray-900 pb-safe">
                    <div className="max-w-4xl mx-auto p-4 md:p-6">
                        <header className="flex justify-between items-center mb-6">
                            <div className="flex items-center space-x-2">
                                <div className="bg-indigo-600 p-2 rounded-lg"><Coins className="text-white w-5 h-5" /></div>
                                <h1 className="text-lg font-bold">CentimOn</h1>
                            </div>
                            <div className="flex items-center gap-3">
                                <span className="text-xs text-gray-500">{user.email}</span>
                                <button onClick={() => signOut(auth)} className="text-gray-500 hover:text-red-600">
                                    <LogOut className="w-5 h-5" />
                                </button>
                            </div>
                        </header>
                        
                        <AccountsBar 
                            accounts={accounts} 
                            activeAccount={activeAccount} 
                            setActiveAccount={setActiveAccount} 
                            onAddAccount={handleAddAccount}
                            onDeleteAccount={handleDeleteAccount}
                        />

                        <DateFilter filter={dateFilter} setFilter={setDateFilter} />

                        <SummaryDashboard transactions={filteredTransactions} activeAccount={activeAccount} accounts={accounts} />
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="space-y-6">
                                <TransactionForm db={db} userId={user.uid} activeAccount={activeAccount} accounts={accounts} />
                                <TransactionsList transactions={filteredTransactions} db={db} userId={user.uid} />
                            </div>
                            <div className="space-y-6">
                                <Analytics transactions={filteredTransactions} activeAccount={activeAccount} />
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>